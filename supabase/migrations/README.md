# Система миграций для AI Feed Manager

В этой директории хранятся все миграции для базы данных проекта AI Feed Manager. Миграции выполняются автоматически при деплое проекта на Supabase.

## Текущие миграции

### 20250522184858_initial_schema.sql
- Начальная структура базы данных
- Создание всех основных таблиц, индексов и связей
- Создание функции `update_updated_at()` и триггеров для обновления временных меток

### 20250522125524_add_category_original_id.sql
- Добавление поля `original_id` в таблицу категорий
- Создание уникального ограничения для сочетания `feed_id` и `original_id`
- Обновление внешних ключей между таблицами продуктов и категорий

### 20250523_add_products_unique_constraint.sql
- Добавление уникального ограничения для сочетания `feed_id` и `external_id` в таблице продуктов
- Оптимизация индекса для ускорения поиска по этим полям

### 20250524000000_fix_category_original_id_type.sql
- Исправление типа поля `category_original_id` в таблице products: изменение с UUID на TEXT
- Обновление внешнего ключа для обеспечения ссылочной целостности

## Правила именования миграций

Имена файлов миграций создаются автоматически при использовании команды:
```
npx supabase migration new имя_миграции
```

## Правила создания миграций

1. **Идемпотентность**: Все миграции должны быть идемпотентными, т.е. их повторное выполнение не должно приводить к ошибкам. Используйте конструкции вроде `IF NOT EXISTS`, `DROP IF EXISTS`, и т.д.

2. **Атомарность**: Каждая миграция должна быть атомарной и выполнять одно логическое изменение в схеме.

3. **Документирование**: Обязательно документируйте миграцию в этом файле с кратким описанием внесенных изменений.

## Как добавить новую миграцию

1. Используйте команду `npx supabase migration new имя_миграции` для создания нового файла миграции.
2. Обновите этот README.md, добавив информацию о новой миграции.
3. Проверьте миграцию на локальной копии базы данных.
4. Для применения миграций используйте `npx supabase db push`.

## Команды для работы с миграциями

```bash
# Создание новой миграции
npx supabase migration new имя_миграции

# Просмотр всех миграций
npx supabase migration list

# Применение миграций к локальной базе данных
npx supabase db reset

# Применение миграций к удаленной базе данных
npx supabase db push

# Получение миграций из удаленной базы данных
npx supabase db pull
```

## Логи изменений в схеме базы данных

### 2025-05-24
- Исправлен тип поля `category_original_id` в таблице products (изменен с UUID на TEXT)

### 2025-05-23
- Добавлено уникальное ограничение для `(feed_id, external_id)` в таблице продуктов
- Улучшена производительность поиска продуктов по внешнему идентификатору

### 2025-05-22
- Создана начальная структура базы данных
- Добавлены все основные таблицы: profiles, feeds, categories, products, feed_ai_settings, ai_settings, logs
- Настроены связи между таблицами и индексы для ускорения запросов
- Добавлена поддержка связи товаров с категориями через original_id 